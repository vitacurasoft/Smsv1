<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Smsv1.2 - SMS pré-rempli (Google Agenda)</title>
  <style>
    :root {
      --bg:#ffffff;
      --fg:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --card:#f9fafb;
      --btn:#111827;
      --btnfg:#ffffff;
      --danger:#b91c1c;
      --ok:#065f46;
    }
    body { font-family: Arial, sans-serif; margin:0; color:var(--fg); background:var(--bg); }
    header {
      position: sticky; top:0; z-index:10;
      background: var(--bg);
      border-bottom:1px solid var(--line);
      padding: 12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    h1 { margin:0; font-size:18px; }
    .right { display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    .pill {
      font-size:12px; color:var(--muted);
      border:1px solid var(--line); border-radius:999px;
      padding:6px 10px;
      max-width: 260px;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    main { padding: 14px; max-width: 920px; margin: 0 auto; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    button {
      border:0; border-radius:10px; padding:12px 14px;
      background:var(--btn); color:var(--btnfg);
      font-weight:700; cursor:pointer;
    }
    button[disabled] { opacity:.5; cursor:not-allowed; }
    select, input[type="text"] {
      border:1px solid var(--line); border-radius:10px; padding:10px 12px;
      font-size:14px;
      background:#fff;
    }
    .status { margin: 10px 0 14px; color:var(--muted); font-size:13px; }
    .card {
      border:1px solid var(--line); border-radius:14px;
      padding: 12px 12px; background: var(--card);
      margin: 10px 0;
    }
    .card h3 { margin:0 0 6px; font-size:16px; }
    .meta { color:var(--muted); font-size:13px; margin: 0 0 10px; }
    .phone { font-weight:700; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .leftActions { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    label { font-size:13px; color:var(--fg); display:flex; align-items:center; gap:8px; }
    .sentInfo { font-size:12px; color:var(--ok); margin-left:28px; margin-top:6px; }
    .warn { font-size:12px; color:var(--danger); margin-top:8px; }
    .divider { height:1px; background:var(--line); margin: 14px 0; }
    .small { font-size:12px; color:var(--muted); line-height:1.4; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body>
  <header>
    <h1>SMS automatique</h1>

    <div class="right">
      <div class="pill" title="Client ID OAuth utilisé (préchargé)"><span class="mono">962693468865-fpumnvpt5517nfs21kobao8l2ejni1qk.apps.googleusercontent.com</span></div>

      <div class="row">
        <select id="senderSelect" title="Numéro d’envoi (pour votre suivi)">
          <option value="0669537791">06 69 53 77 91 (par défaut)</option>
          <option value="__custom__">Autre numéro…</option>
        </select>
        <button id="connectBtn">Se connecter</button>
      </div>
    </div>
  </header>

  <main>
    <div class="row">
      <button id="loadBtn" disabled>Charger les RDV (aujourd’hui + demain)</button>
    </div>

    <div id="status" class="status">Non connecté.</div>

    <div id="list"></div>

    <div class="divider"></div>

    <div class="small">
      <div><strong>Remarque</strong> : l’application détecte dans la description les champs au format <span class="mono">Clé: valeur</span> (ex. <span class="mono">Téléphone: 0677904214</span>). Les libellés <span class="mono">Téléphone</span> et <span class="mono">Telephone</span> sont reconnus.</div>
      <div>Les cases “SMS envoyé” servent uniquement de suivi local (stockage dans votre navigateur). Rien n’est envoyé automatiquement.</div>
    </div>
  </main>

  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <script>
    // === Configuration ===
    const CLIENT_ID = "962693468865-fpumnvpt5517nfs21kobao8l2ejni1qk.apps.googleusercontent.com";
    const SCOPES = "https://www.googleapis.com/auth/calendar.readonly";
    const SENT_KEY = "smsv1_sent_map_v1";
    const SENDER_KEY = "smsv1_sender_v1";

    // === UI refs ===
    const statusEl = document.getElementById("status");
    const listEl = document.getElementById("list");
    const connectBtn = document.getElementById("connectBtn");
    const loadBtn = document.getElementById("loadBtn");
    const senderSelect = document.getElementById("senderSelect");

    // === State ===
    let tokenClient = null;
    let accessToken = null;

    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    function getSenderDigits() {
      const v = senderSelect.value;
      if (v === "__custom__") {
        const cur = localStorage.getItem(SENDER_KEY) || "";
        const ans = prompt("Entrez le numéro (format libre).", cur || "06");
        if (!ans) {
          senderSelect.value = "0669537791";
          localStorage.setItem(SENDER_KEY, "0669537791");
          return "0669537791";
        }
        const digits = ans.replace(/\D+/g, "");
        localStorage.setItem(SENDER_KEY, digits);

        let opt = senderSelect.querySelector('option[data-custom="1"]');
        const pretty = ans.trim();
        if (!opt) {
          opt = document.createElement("option");
          opt.dataset.custom = "1";
          senderSelect.insertBefore(opt, senderSelect.querySelector('option[value="__custom__"]'));
        }
        opt.value = digits;
        opt.textContent = pretty + " (perso)";
        senderSelect.value = digits;
        return digits;
      }
      localStorage.setItem(SENDER_KEY, v);
      return v;
    }

    function prettyPhone(digits) {
      const d = (digits || "").replace(/\D+/g, "");
      if (d.length === 10 && d.startsWith("0")) {
        return d.replace(/(\d{2})(?=\d)/g, "$1 ").trim();
      }
      return digits;
    }

    function loadSentMap() {
      try {
        return JSON.parse(localStorage.getItem(SENT_KEY) || "{}");
      } catch(e) {
        return {};
      }
    }

    function saveSentMap(map) {
      localStorage.setItem(SENT_KEY, JSON.stringify(map));
    }

    function markSent(eventId, isSent) {
      const map = loadSentMap();
      if (!isSent) {
        delete map[eventId];
        saveSentMap(map);
        return;
      }
      const sender = getSenderDigits();
      map[eventId] = { sent: true, sentAt: new Date().toISOString(), from: sender };
      saveSentMap(map);
    }

    function getSentInfo(eventId) {
      const map = loadSentMap();
      return map[eventId] || null;
    }

    function formatDateTime(dt) {
      try {
        const d = new Date(dt);
        return d.toLocaleString("fr-FR", { weekday:"short", year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
      } catch(e) {
        return dt;
      }
    }

    function getEventTimeRange(ev) {
      const start = ev.start?.dateTime || ev.start?.date;
      const end = ev.end?.dateTime || ev.end?.date;
      return { start, end };
    }

    function parseFields(description) {
      const out = {};
      if (!description) return out;
      const lines = description.split(/\r?\n/);
      for (const raw of lines) {
        const line = (raw || "").trim();
        if (!line) continue;

        const m = line.match(/^([^:]+)\s*:\s*(.+)$/);
        if (!m) continue;

        const key = m[1].trim().toLowerCase()
          .replace(/[éèêë]/g, "e")
          .replace(/[àâä]/g, "a")
          .replace(/[îï]/g, "i")
          .replace(/[ôö]/g, "o")
          .replace(/[ùûü]/g, "u")
          .replace(/\s+/g, " ");

        out[key] = m[2].trim();
      }
      return out;
    }

    function extractPhone(ev) {
      const desc = (ev.description || "");
      const fields = parseFields(desc);

      // 1) Priorité: champs structurés "Téléphone: ..."
      const candidates = [
        fields["telephone"],
        fields["téléphone"],
        fields["tel"],
        fields["tél"],
        fields["phone"],
        fields["mobile"],
        fields["telephone mobile"],
        fields["telephone portable"],
        fields["téléphone mobile"],
        fields["téléphone portable"],
      ].filter(Boolean);

      // 2) Recherche robuste dans tout le texte (tolère espaces, tirets, points, +33, etc.)
      const rxKeyed = /(telephone|téléphone)\s*[:\-]?\s*(\+?\d[\d\s\.\-]{8,})/ig;
      let m;
      while ((m = rxKeyed.exec(desc)) !== null) {
        if (m[2]) candidates.push(m[2]);
      }

      // 3) Dernier recours: détecter un numéro FR plausible n'importe où dans la description
      // Ex: 06 77 90 42 14, 0677904214, +33 6 77 90 42 14
      const rxFR = /(\+33\s*[67](?:[\s\.\-]*\d){8}|0\s*[67](?:[\s\.\-]*\d){8})/g;
      const m2 = desc.match(rxFR);
      if (m2 && m2.length) candidates.push(m2[0]);

      const raw = candidates.find(Boolean) || "";
      let digits = raw.replace(/\D+/g, "");

      // Normalisation +33XXXXXXXXX -> 0XXXXXXXXX
      if (digits.startsWith("33") && digits.length >= 11) {
        digits = "0" + digits.slice(2);
      }

      if (digits.length < 9) return null;
      return digits;
    }

    function buildSmsText(ev) {
      const fields = parseFields(ev.description || "");
      const prenomRaw =
        fields["prénom"] || fields["prenom"] ||
        (ev.summary || "").replace(/^\s*RDV\s*\d*\s*/i, "").trim().split(/\s+/)[0] ||
        "";

      const prenom = (prenomRaw || "").trim();
      const when = new Date(ev.start.dateTime || ev.start.date);
      const { dayName, dayNum, monthName, hhmm } = formatFrenchDateParts(when);

      const sender = getSenderNumber(); // pour que la personne puisse répondre au bon numéro

      return [
        `Bonjour ${prenom}`,
        ``,
        `Je vous confirme notre rendez-vous ce ${dayName} ${dayNum} ${monthName} à ${hhmm}`,
        ``,
        `Le cabinet se situe au 7, Rond-Point du Parc des Sports à Perpignan.`,
        `(Rez de chaussée, à droite).`,
        `Un parking gratuit se trouve à 50 mètres, juste en face du parc des sports.`,
        ``,
        `Bien cordialement,`,
        `Damien Leignel`,
        `Psychopraticien, Hypnose, PNL, EMDR, TCC, Analyse Transactionnelle & Coaching`,
        `Tél: ${sender}`
      ].join("\n");
    }

    function openSms(phoneDigits, text) {
      const phone = phoneDigits.replace(/\D+/g, "");
      const body = encodeURIComponent(text);
      window.location.href = "sms:" + phone + "?&body=" + body;
    }

    async function fetchEvents(timeMin, timeMax) {
      if (!accessToken) throw new Error("Non connecté.");
      const url = new URL("https://www.googleapis.com/calendar/v3/calendars/primary/events");
      url.searchParams.set("timeMin", timeMin.toISOString());
      url.searchParams.set("timeMax", timeMax.toISOString());
      url.searchParams.set("singleEvents", "true");
      url.searchParams.set("orderBy", "startTime");
      url.searchParams.set("maxResults", "50");

      const res = await fetch(url.toString(), {
        headers: { "Authorization": "Bearer " + accessToken }
      });

      const data = await res.json();
      if (!res.ok) {
        const msg = data?.error?.message || "Erreur API Google Calendar";
        throw new Error("Erreur API Google Calendar : " + res.status + " - " + msg);
      }
      return data.items || [];
    }

    function render(events) {
      listEl.innerHTML = "";
      if (!events.length) {
        listEl.innerHTML = '<div class="status">Aucun rendez-vous sur la période.</div>';
        return;
      }

      const sentMap = loadSentMap();

      events.forEach((ev) => {
        const card = document.createElement("div");
        card.className = "card";

        const title = document.createElement("h3");
        title.textContent = ev.summary || "(Sans titre)";
        card.appendChild(title);

        const tr = getEventTimeRange(ev);
        const meta = document.createElement("div");
        meta.className = "meta";
        const s = tr.start ? new Date(tr.start).toLocaleString("fr-FR", { weekday:"long", day:"2-digit", month:"2-digit", hour:"2-digit", minute:"2-digit" }) : "";
        const e = tr.end ? new Date(tr.end).toLocaleString("fr-FR", { hour:"2-digit", minute:"2-digit" }) : "";
        meta.textContent = s && e ? (s + " → " + e) : (s || "");
        card.appendChild(meta);

        const phoneDigits = extractPhone(ev);
        const phoneLine = document.createElement("div");
        phoneLine.className = "meta";
        phoneLine.innerHTML = phoneDigits
          ? 'Téléphone : <span class="phone">' + prettyPhone(phoneDigits) + '</span>'
          : 'Téléphone : <span class="phone">non trouvé</span>';
        card.appendChild(phoneLine);

        const actions = document.createElement("div");
        actions.className = "actions";

        const left = document.createElement("div");
        left.className = "leftActions";

        const label = document.createElement("label");
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !!sentMap[ev.id];
        label.appendChild(cb);
        const span = document.createElement("span");
        span.textContent = "SMS envoyé";
        label.appendChild(span);
        left.appendChild(label);

        const prepBtn = document.createElement("button");
        prepBtn.textContent = "Préparer le SMS";
        prepBtn.disabled = !phoneDigits;
        prepBtn.addEventListener("click", () => {
          if (!phoneDigits) {
            alert("Téléphone non trouvé. Ajoutez une ligne : Téléphone: 06XXXXXXXX");
            return;
          }
          openSms(phoneDigits, buildSmsText(ev));
        });

        actions.appendChild(left);
        actions.appendChild(prepBtn);
        card.appendChild(actions);

        const infoEl = document.createElement("div");
        infoEl.className = "sentInfo";
        const info = getSentInfo(ev.id);
        if (info) {
          infoEl.textContent = "Envoyé le " + formatDateTime(info.sentAt) + " (depuis " + prettyPhone(info.from) + ")";
        } else {
          infoEl.style.display = "none";
        }
        card.appendChild(infoEl);

        cb.addEventListener("change", () => {
          markSent(ev.id, cb.checked);
          const newInfo = getSentInfo(ev.id);
          if (newInfo) {
            infoEl.textContent = "Envoyé le " + formatDateTime(newInfo.sentAt) + " (depuis " + prettyPhone(newInfo.from) + ")";
            infoEl.style.display = "block";
          } else {
            infoEl.textContent = "";
            infoEl.style.display = "none";
          }
        });

        if (!phoneDigits) {
          const warn = document.createElement("div");
          warn.className = "warn";
          warn.textContent = "Téléphone non trouvé dans la description. Ajoutez une ligne : Téléphone: 06XXXXXXXX";
          card.appendChild(warn);
        }

        listEl.appendChild(card);
      });
    }

    async function loadTodayTomorrow() {
      const now = new Date();
      const start = new Date(now);
      start.setHours(0,0,0,0);

      const end = new Date(now);
      end.setDate(end.getDate() + 1);
      end.setHours(23,59,59,999);

      setStatus("Chargement des rendez-vous (aujourd’hui + demain)...");
      try {
        const events = await fetchEvents(start, end);
        render(events);
        setStatus("Chargé : " + events.length + " rendez-vous.");
      } catch (e) {
        setStatus(e.message);
        alert(e.message);
      }
    }

    function initOAuth() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (resp) => {
          if (resp.error) {
            setStatus("Connexion refusée : " + resp.error);
            return;
          }
          accessToken = resp.access_token;
          setStatus("Connecté. Vous pouvez charger les RDV.");
          loadBtn.disabled = false;
          connectBtn.textContent = "Reconnecter";
        },
      });
    }

    window.addEventListener("load", () => {
      // restore sender
      const saved = (localStorage.getItem(SENDER_KEY) || "0669537791").replace(/\D+/g, "");
      if (saved && saved !== "0669537791") {
        let opt = document.createElement("option");
        opt.dataset.custom = "1";
        opt.value = saved;
        opt.textContent = prettyPhone(saved) + " (perso)";
        senderSelect.insertBefore(opt, senderSelect.querySelector('option[value="__custom__"]'));
        senderSelect.value = saved;
      } else {
        senderSelect.value = "0669537791";
      }

      initOAuth();

      senderSelect.addEventListener("change", () => {
        getSenderDigits();
      });

      connectBtn.addEventListener("click", () => {
        if (!tokenClient) initOAuth();
        tokenClient.requestAccessToken({ prompt: accessToken ? "" : "consent" });
      });

      loadBtn.addEventListener("click", loadTodayTomorrow);
    });
  </script>
</body>
</html>
